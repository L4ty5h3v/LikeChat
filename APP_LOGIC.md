# Логика приложения LikeChat Farcaster

## Общий Flow приложения

### 1. Главная страница (`/`) - Выбор типа активности

**Что происходит:**
- Пользователь авторизуется через Farcaster кошелек
- Выбирает тип активности: **LIKE**, **RECAST** или **COMMENT**
- Выбранная активность сохраняется в `localStorage` как `selected_activity`
- Данные пользователя сохраняются в `localStorage` как `farcaster_user`

**Результат:**
- Редирект на страницу `/tasks` для выполнения заданий

---

### 2. Страница задач (`/tasks`) - Выполнение заданий

**Что происходит:**
- Загружаются все ссылки (задания) от других пользователей
- Фильтрация по выбранному типу активности (`like`, `recast`, `comment`)
- Пользователь видит список заданий (обычно 10 ссылок)
- Для каждого задания:
  - Нажимает кнопку **"Open Post"** → открывается ссылка в новой вкладке
  - Выполняет действие (лайк/рекаст/комментарий) в Farcaster
  - Нажимает кнопку **"VERIFY COMPLETION"** для проверки выполнения
  - Система проверяет через Neynar API, выполнено ли действие
  - Если выполнено → задание помечается как завершенное (зеленый цвет)
  - Если не выполнено → задание выделяется красным цветом с ошибкой

**Автоматические проверки:**
- Каждые 2 секунды обновляется список заданий
- После открытия ссылки запускается автоматический polling (проверка каждые 30 секунд)

**Автоматические редиректы:**
- ✅ Если все 10 заданий выполнены И токен **НЕ куплен** → редирект на `/buyToken` (через 2 секунды)
- ✅ Если все 10 заданий выполнены И токен **куплен** И ссылка **не опубликована** → редирект на `/submit` (через 2 секунды)
- ✅ Если ссылка уже опубликована → остается на странице `/tasks`

---

### 3. Страница покупки токена (`/buyToken`) - Покупка MCT токена

**Что происходит:**
- Пользователь подключает кошелек (Farcaster Wallet)
- Видит свой баланс USDC и MCT токенов
- Нажимает кнопку **"❤️ BUY MRS. CRYPTO TOKEN FOR $0.10"**
- Выполняется swap: 0.10 USDC → MCT токены через Farcaster Swap API
- Система отслеживает изменение баланса MCT токенов
- После успешной покупки:
  - Токен помечается как купленный в базе данных (`token_purchased = true`)
  - Отправляется уведомление через MiniKit SDK
  - Публикуется cast в Warpcast с tx hash (если доступен)

**Автоматические редиректы:**
- ✅ После покупки токена → автоматический редирект на `/submit` (через 2 секунды)

**Кнопки после покупки:**
- Если токен куплен → показывается кнопка **"PUBLISH LINK →"** (ведет на `/submit`)
- Если токен не куплен → показывается кнопка покупки

**Важно:**
- Покупка токена совершается **только один раз**
- После покупки токена всегда можно опубликовать ссылку (не требуется выполнение всех задач)

---

### 4. Страница публикации ссылки (`/submit`) - Публикация своей ссылки

**Что происходит:**
- Проверяется, что токен куплен (`token_purchased = true`)
- Проверяется, что в системе есть минимум 10 ссылок от других пользователей
- Проверяется, что пользователь еще не публиковал ссылку
- Пользователь вводит ссылку на свой cast (Farcaster/Warpcast URL)
- Выбирает тип активности (должен совпадать с выбранным на главной странице)
- Нажимает кнопку **"PUBLISH LINK"**
- Система:
  - Валидирует URL (должен быть с warpcast.com или farcaster.xyz)
  - Извлекает cast hash из URL
  - Сохраняет ссылку в базу данных
  - Публикует cast в Farcaster через MiniKit SDK (опционально)
  - Устанавливает флаг `link_published = true` в `sessionStorage` и `localStorage`

**Результат:**
- Ссылка пользователя появляется в списке заданий для других пользователей
- Редирект на страницу `/tasks` (где пользователь видит свою ссылку в списке)

**Защита от повторной публикации:**
- Флаг `link_published` блокирует повторный доступ к странице `/submit`
- Если пользователь пытается зайти на `/submit` после публикации → автоматический редирект на `/tasks`

---

## Упрощенный Flow (после покупки токена)

**Новый упрощенный путь:**
1. Пользователь покупает токен → автоматический редирект на `/submit`
2. Пользователь публикует ссылку → редирект на `/tasks`
3. Ссылка появляется в списке заданий для других пользователей

**Важно:** После покупки токена **НЕ требуется** выполнение всех 10 заданий для публикации ссылки.

---

## Проверки и валидации

### На странице `/tasks`:
- ✅ Проверка авторизации пользователя
- ✅ Проверка выбранного типа активности
- ✅ Проверка выполнения заданий через Neynar API
- ✅ Автоматическое обновление списка заданий каждые 2 секунды

### На странице `/buyToken`:
- ✅ Проверка авторизации пользователя
- ✅ Проверка подключения кошелька
- ✅ Проверка баланса USDC (минимум 0.10 USDC)
- ✅ Проверка статуса покупки токена в БД
- ✅ Отслеживание изменения баланса MCT токенов

### На странице `/submit`:
- ✅ Проверка авторизации пользователя
- ✅ Проверка покупки токена (`token_purchased = true`)
- ✅ Проверка, что пользователь еще не публиковал ссылку
- ✅ Валидация формата URL (warpcast.com или farcaster.xyz)

**Важно:** После покупки токена можно публиковать ссылку сразу, без проверки на 10 ссылок от других пользователей.

---

## Состояния и флаги

### `selected_activity`
- Хранится в `localStorage`
- Типы: `'like'`, `'recast'`, `'comment'`
- Используется для фильтрации заданий

### `link_published`
- Хранится в `sessionStorage` и `localStorage`
- Значение: `'true'` или отсутствует
- Блокирует повторный доступ к странице `/submit`

### `token_purchased`
- Хранится в базе данных (Upstash Redis)
- Значение: `true` или `false`
- Определяет, может ли пользователь публиковать ссылку

### `completed_links`
- Хранится в базе данных
- Массив ID завершенных ссылок
- Используется для подсчета выполненных заданий

---

## API Endpoints

### `/api/tasks`
- Возвращает список всех ссылок (заданий)
- Фильтрация по типу активности

### `/api/user-progress`
- Возвращает прогресс пользователя:
  - `completed_links` - массив ID завершенных ссылок
  - `token_purchased` - статус покупки токена
  - `current_link_id` - ID опубликованной ссылки

### `/api/verify-activity`
- Проверяет выполнение действия (лайк/рекаст/комментарий) через Neynar API
- Принимает: `castUrl`, `userFid`, `activityType`
- Возвращает: `completed: true/false`

### `/api/mark-completed`
- Помечает ссылку как выполненную пользователем
- Сохраняет в `completed_links` пользователя

### `/api/submit-link`
- Публикует ссылку пользователя
- Проверяет:
  - Токен куплен
  - Пользователь еще не публиковал ссылку
- Сохраняет ссылку в базу данных

**Важно:** После покупки токена можно публиковать ссылку сразу, без проверки на 10 ссылок от других пользователей.

---

## База данных (Upstash Redis)

### Структура данных:

**User Progress:**
```json
{
  "user_fid": 12345,
  "completed_links": ["link_id_1", "link_id_2", ...],
  "token_purchased": true,
  "selected_activity": "like",
  "current_link_id": "link_id_user"
}
```

**Link Submission:**
```json
{
  "id": "link_id",
  "user_fid": 12345,
  "username": "@username",
  "pfp_url": "https://...",
  "cast_url": "https://farcaster.xyz/...",
  "activity_type": "like",
  "completed_by": [12345, 67890, ...]
}
```

---

## Особенности реализации

1. **Автоматический polling** - после открытия ссылки система автоматически проверяет выполнение каждые 30 секунд (до 10 попыток)

2. **Красное выделение ошибок** - задания с ошибками выделяются красным цветом с сообщением об ошибке

3. **Защита от повторной публикации** - флаг `link_published` блокирует повторный доступ к странице публикации

4. **Автоматические редиректы** - система автоматически перенаправляет пользователя на следующую страницу после выполнения условий

5. **Проверка через Neynar API** - все проверки активности выполняются через официальный Neynar API для надежности

---

## Последовательность действий пользователя

### Полный цикл:
1. **Главная страница** → Выбор типа активности → Редирект на `/tasks`
2. **Страница задач** → Выполнение 10 заданий → Редирект на `/buyToken`
3. **Страница покупки** → Покупка токена → Редирект на `/submit`
4. **Страница публикации** → Публикация ссылки → Редирект на `/tasks`

### Упрощенный цикл (после покупки токена):
1. **Страница покупки** → Покупка токена → Редирект на `/submit`
2. **Страница публикации** → Публикация ссылки → Редирект на `/tasks`

---

## Важные моменты

- ✅ Покупка токена совершается **только один раз**
- ✅ После покупки токена можно публиковать ссылку **без выполнения всех задач**
- ✅ Задания проверяются автоматически через Neynar API
- ✅ Ссылка пользователя появляется в списке заданий для других пользователей
- ✅ Защита от повторной публикации через флаг `link_published`

